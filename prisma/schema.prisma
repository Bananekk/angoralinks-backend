// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========== ENUMS ==========

enum PayoutMethod {
  PAYPAL
  BITCOIN
  BANK_TRANSFER
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

enum FraudAlertStatus {
  PENDING
  APPROVED
  BLOCKED_REFERRED
  BLOCKED_BOTH
  REFERRAL_DISABLED
}

enum TwoFactorMethod {
  TOTP
  WEBAUTHN
  BACKUP_CODE
}

enum TwoFactorAction {
  ENABLED
  DISABLED
  VERIFIED
  FAILED
  BACKUP_USED
  BACKUP_REGENERATED
  WEBAUTHN_REGISTERED
  WEBAUTHN_REMOVED
  ADMIN_RESET
  ADMIN_REQUIRED
}

// ========== MODELE ==========

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password_hash        String
  balance              Decimal   @default(0) @db.Decimal(10, 4)
  totalEarned          Decimal   @default(0) @map("total_earned") @db.Decimal(10, 4)
  isVerified           Boolean   @default(false) @map("is_verified")
  isActive             Boolean   @default(true) @map("is_active")
  isAdmin              Boolean   @default(false) @map("is_admin")
  verification_code    String?
  verification_expires DateTime?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  lastLoginAt          DateTime? @map("last_login_at")
  lastLoginIp          String?   @map("last_login_ip")
  registrationIp       String?   @map("registration_ip")
  pendingBalance       Decimal?  @default(0) @map("pending_balance") @db.Decimal(10, 6)

  // ========== POLA 2FA ==========
  twoFactorEnabled    Boolean           @default(false) @map("two_factor_enabled")
  twoFactorSecret     String?           @map("two_factor_secret")
  twoFactorMethod     TwoFactorMethod[] @default([])
  twoFactorRequired   Boolean           @default(false) @map("two_factor_required")
  twoFactorRequiredAt DateTime?         @map("two_factor_required_at")
  twoFactorRequiredBy String?           @map("two_factor_required_by")
  twoFactorEnabledAt  DateTime?         @map("two_factor_enabled_at")
  twoFactorLastUsedAt DateTime?         @map("two_factor_last_used_at")

  // ========== POLA REFERALI ==========
  referralCode           String?   @unique @map("referral_code")
  referralEarnings       Decimal   @default(0) @map("referral_earnings") @db.Decimal(10, 4)
  referredById           String?   @map("referred_by_id")
  referredBy             User?     @relation("Referrals", fields: [referredById], references: [id])
  referrals              User[]    @relation("Referrals")
  referralBonusExpires   DateTime? @map("referral_bonus_expires")
  referralDisabled       Boolean   @default(false) @map("referral_disabled")
  referralDisabledAt     DateTime? @map("referral_disabled_at")
  referralDisabledReason String?   @map("referral_disabled_reason") @db.VarChar(255)

  // Pola wykrywania fraudu
  referralIpHash         String?   @map("referral_ip_hash") @db.VarChar(64)
  deviceFingerprint      String?   @map("device_fingerprint") @db.VarChar(64)
  userAgentHash          String?   @map("user_agent_hash") @db.VarChar(64)
  browserLanguage        String?   @map("browser_language") @db.VarChar(10)
  screenResolution       String?   @map("screen_resolution") @db.VarChar(20)
  timezone               String?   @map("timezone") @db.VarChar(50)
  referralFraudFlag      Boolean   @default(false) @map("referral_fraud_flag")
  referralFraudReason    String?   @map("referral_fraud_reason") @db.VarChar(255)
  referralFraudCheckedAt DateTime? @map("referral_fraud_checked_at")

  // ========== RELACJE ==========
  earnings             DailyEarning[]
  ipLogs               IpLog[]
  links                Link[]
  payouts              Payout[]
  referralCommissions  ReferralCommission[] @relation("ReferrerCommissions")
  generatedCommissions ReferralCommission[] @relation("ReferredCommissions")
  fraudAlertsAsReferrer FraudAlert[]        @relation("FraudAlertReferrer")
  fraudAlertsAsReferred FraudAlert[]        @relation("FraudAlertReferred")

  // ========== RELACJE 2FA ==========
  webAuthnCredentials WebAuthnCredential[]
  backupCodes         BackupCode[]
  twoFactorLogs       TwoFactorLog[]

  @@index([referredById])
  @@map("users")
}

model WebAuthnCredential {
  id                   String   @id @default(cuid())
  userId               String   @map("user_id")
  credentialId         String   @unique @map("credential_id")
  credentialPublicKey  String   @map("credential_public_key") @db.Text
  counter              BigInt   @default(0)
  credentialDeviceType String   @map("credential_device_type") @db.VarChar(32)
  credentialBackedUp   Boolean  @default(false) @map("credential_backed_up")
  transports           String[] @default([])
  deviceName           String?  @map("device_name") @db.VarChar(100)
  lastUsedAt           DateTime? @map("last_used_at")
  createdAt            DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialId])
  @@map("webauthn_credentials")
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  codeHash  String    @map("code_hash")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([codeHash])
  @@map("backup_codes")
}

model TwoFactorLog {
  id         String           @id @default(cuid())
  userId     String           @map("user_id")
  action     TwoFactorAction
  method     TwoFactorMethod?
  success    Boolean
  ipAddress  String?          @map("ip_address")
  userAgent  String?          @map("user_agent") @db.VarChar(500)
  failReason String?          @map("fail_reason") @db.VarChar(255)
  createdAt  DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("two_factor_logs")
}

model FraudAlert {
  id             String           @id @default(cuid())
  createdAt      DateTime         @default(now()) @map("created_at")
  referrerId     String           @map("referrer_id")
  referrer       User             @relation("FraudAlertReferrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredId     String           @map("referred_id")
  referred       User             @relation("FraudAlertReferred", fields: [referredId], references: [id], onDelete: Cascade)
  reasons        String[]         @default([])
  riskScore      Int              @default(0) @map("risk_score")
  ipMatch        Boolean          @default(false) @map("ip_match")
  deviceMatch    Boolean          @default(false) @map("device_match")
  userAgentMatch Boolean          @default(false) @map("user_agent_match")
  timingAnomaly  Boolean          @default(false) @map("timing_anomaly")
  status         FraudAlertStatus @default(PENDING)
  resolvedAt     DateTime?        @map("resolved_at")
  resolvedById   String?          @map("resolved_by_id")
  resolution     String?          @db.VarChar(255)
  adminNotes     String?          @map("admin_notes") @db.Text

  @@index([status])
  @@index([createdAt])
  @@index([referrerId])
  @@index([referredId])
  @@map("fraud_alerts")
}

model Link {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  originalUrl  String   @map("original_url")
  shortCode    String   @unique @map("short_code")
  title        String?
  description  String?
  totalClicks  Int      @default(0) @map("total_clicks")
  totalEarned  Decimal  @default(0) @map("total_earned") @db.Decimal(10, 4)
  is_active    Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt
  uniqueClicks Int?     @default(0) @map("unique_clicks")

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  visits Visit[]

  @@index([userId])
  @@index([shortCode])
  @@map("links")
}

model Visit {
  id             String   @id @default(cuid())
  linkId         String   @map("link_id")
  ip_address     String
  country        String?
  city           String?
  device         String?
  browser        String?
  referer        String?
  earned         Decimal  @default(0) @db.Decimal(10, 4)
  completed      Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  encryptedIp    String?  @map("encrypted_ip")
  userAgent      String?  @map("user_agent")
  ipHash         String   @map("ip_hash") @db.VarChar(64)
  countryTier    Int?     @default(3) @map("country_tier")
  platformEarned Decimal? @default(0) @map("platform_earned") @db.Decimal(10, 6)
  cpmRateUsed    Decimal? @default(0) @map("cpm_rate_used") @db.Decimal(10, 4)
  isUnique       Boolean? @default(true) @map("is_unique")
  adDisplayed    Boolean? @default(false) @map("ad_displayed")
  fraudBlocked   Boolean? @default(false) @map("fraud_blocked")
  blockReason    String?  @map("block_reason") @db.VarChar(255)

  link                Link                 @relation(fields: [linkId], references: [id], onDelete: Cascade)
  referralCommissions ReferralCommission[]

  @@index([linkId])
  @@index([createdAt])
  @@index([country], map: "idx_visits_country")
  @@index([ipHash], map: "idx_visits_ip_hash")
  @@index([ipHash, linkId, createdAt], map: "idx_visits_ip_hash_link_created")
  @@index([isUnique], map: "idx_visits_is_unique")
  @@index([ip_address])
  @@map("visits")
}

model CpmRate {
  id           String    @id @default(cuid())
  countryCode  String    @unique @map("country_code")
  countryName  String    @map("country_name")
  tier         Int       @default(3)
  cpm_rate     Decimal   @db.Decimal(10, 4)
  isActive     Boolean   @default(true) @map("is_active")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  updated_by   String?
  baseCpm      Decimal   @map("base_cpm") @db.Decimal(10, 4)
  userCpm      Decimal   @map("user_cpm") @db.Decimal(10, 4)
  source       String?   @default("manual") @db.VarChar(20)
  lastVerified DateTime? @map("last_verified") @db.Timestamp(6)

  @@index([isActive])
  @@index([tier])
  @@map("cpm_rates")
}

model DailyEarning {
  id               String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId           String    @map("user_id")
  date             DateTime  @db.Date
  country          String?   @default("XX") @db.VarChar(10)
  visits           Int?      @default(0)
  uniqueVisits     Int?      @default(0) @map("unique_visits")
  userEarnings     Decimal?  @default(0) @map("user_earnings") @db.Decimal(10, 6)
  platformEarnings Decimal?  @default(0) @map("platform_earnings") @db.Decimal(10, 6)
  status           String?   @default("pending") @db.VarChar(20)
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, date, country])
  @@index([date], map: "idx_daily_earnings_date")
  @@index([status], map: "idx_daily_earnings_status")
  @@index([userId], map: "idx_daily_earnings_user")
  @@map("daily_earnings")
}

model AdsterraSync {
  id               String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  date             DateTime  @unique @db.Date
  adsterraRevenue  Decimal?  @default(0) @map("adsterra_revenue") @db.Decimal(10, 4)
  impressions      Int?      @default(0)
  clicks           Int?      @default(0)
  ourVisits        Int?      @default(0) @map("our_visits")
  ourUserPayout    Decimal?  @default(0) @map("our_user_payout") @db.Decimal(10, 4)
  ourPlatformCut   Decimal?  @default(0) @map("our_platform_cut") @db.Decimal(10, 4)
  discrepancy      Decimal?  @db.Decimal(10, 2)
  correctionFactor Decimal?  @default(1.0) @map("correction_factor") @db.Decimal(10, 4)
  status           String?   @default("pending") @db.VarChar(20)
  notes            String?
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@map("adsterra_sync")
}

model Payout {
  id          String       @id @default(cuid())
  userId      String       @map("user_id")
  amount      Decimal      @db.Decimal(10, 4)
  method      PayoutMethod
  address     String
  status      PayoutStatus @default(PENDING)
  createdAt   DateTime     @default(now()) @map("created_at")
  processedAt DateTime?    @map("processed_at")
  adminNote   String?      @map("admin_note") @db.VarChar(500)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("payouts")
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([isRead])
  @@map("contact_messages")
}

model PlatformSettings {
  id            String   @id @default(cuid())
  setting_key   String   @unique
  setting_value String
  description   String?
  updatedAt     DateTime @updatedAt @map("updated_at")
  updated_by    String?

  @@map("platform_settings")
}

model cpm_rate_history {
  id           String   @id @default(cuid())
  country_code String
  old_rate     Decimal  @db.Decimal(10, 4)
  new_rate     Decimal  @db.Decimal(10, 4)
  changed_by   String
  changed_at   DateTime @default(now())

  @@index([changed_at])
  @@index([country_code])
}

model IpLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  encryptedIp String   @map("encrypted_ip")
  action      String
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("ip_logs")
}

model ReferralCommission {
  id              String    @id @default(cuid())
  referrerId      String    @map("referrer_id")
  referredId      String    @map("referred_id")
  visitId         String?   @map("visit_id")
  amount          Decimal   @db.Decimal(10, 6)
  referredEarning Decimal   @map("referred_earning") @db.Decimal(10, 6)
  commissionRate  Decimal   @map("commission_rate") @db.Decimal(5, 4)
  status          String    @default("processed") @db.VarChar(20)
  createdAt       DateTime  @default(now()) @map("created_at")
  processedAt     DateTime? @map("processed_at")

  referrer User   @relation("ReferrerCommissions", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User   @relation("ReferredCommissions", fields: [referredId], references: [id], onDelete: Cascade)
  visit    Visit? @relation(fields: [visitId], references: [id], onDelete: SetNull)

  @@index([referrerId])
  @@index([referredId])
  @@index([createdAt])
  @@map("referral_commissions")
}

model SystemSettings {
  id                     String   @id @default("settings")
  referralCommissionRate Decimal  @default(0.10) @map("referral_commission_rate") @db.Decimal(5, 4)
  referralBonusDuration  Int?     @map("referral_bonus_duration")
  minReferralPayout      Decimal  @default(5.00) @map("min_referral_payout") @db.Decimal(10, 2)
  referralSystemActive   Boolean  @default(true) @map("referral_system_active")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}